# =============================================================================
# Direttore — nginx Reverse Proxy Configuration
#
# URL layout (single hostname, e.g. direttore.example.com):
#
#   /api/*, /docs, /redoc, /openapi.json  → FastAPI backend  (port 8000)
#   /                                     → React frontend   (port 5173 dev /
#                                                              port 80  Docker)
#
# ── Deployment variants ───────────────────────────────────────────────────────
#   Bare-metal / local   upstream addresses: 127.0.0.1:8000 / 127.0.0.1:5173
#   Docker Compose       replace with service names: api:8000 / frontend:80
#                        and add inside the server block:
#                            resolver 127.0.0.11 valid=10s;
#
# ── TLS ───────────────────────────────────────────────────────────────────────
#   If you do NOT have TLS yet, use the plain HTTP block at the bottom of
#   this file and delete/skip the HTTPS server block.
# =============================================================================

# ── Upstreams ─────────────────────────────────────────────────────────────────
upstream direttore_api {
    server 127.0.0.1:8000;
    keepalive 32;           # persistent connections to FastAPI
}

upstream direttore_frontend {
    server 127.0.0.1:5173; # Vite dev server   — OR — 127.0.0.1:80 in prod/Docker
    keepalive 16;
}

# =============================================================================
# HTTPS server  (requires valid TLS certificates)
# =============================================================================

# ── HTTP → HTTPS redirect ─────────────────────────────────────────────────────
server {
    listen 80;
    listen [::]:80;
    server_name direttore.example.com;   # ← change to your actual domain/IP

    # ACME / Let's Encrypt challenge pass-through
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ── Main TLS server ───────────────────────────────────────────────────────────
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;                            # correct form for nginx ≥ 1.25.1
                                         # use "listen 443 ssl http2;" for older nginx
    server_name direttore.example.com;   # ← change to your actual domain/IP

    # ── TLS certificates ──────────────────────────────────────────────────────
    # Replace with your real paths (certbot, ACME, custom CA, etc.)
    ssl_certificate     /etc/letsencrypt/live/direttore.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/direttore.example.com/privkey.pem;

    # ── TLS settings ──────────────────────────────────────────────────────────
    ssl_protocols             TLSv1.2 TLSv1.3;
    ssl_ciphers               ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
    ssl_prefer_server_ciphers off;
    ssl_session_cache         shared:SSL:10m;
    ssl_session_timeout       1d;

    # OCSP stapling — requires a working DNS resolver
    resolver              1.1.1.1 8.8.8.8 valid=300s;
    resolver_timeout      5s;
    ssl_stapling          on;
    ssl_stapling_verify   on;
    ssl_trusted_certificate /etc/letsencrypt/live/direttore.example.com/chain.pem;

    # ── Security headers ──────────────────────────────────────────────────────
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options    "nosniff"                                      always;
    add_header X-Frame-Options           "SAMEORIGIN"                                   always;
    add_header Referrer-Policy           "strict-origin-when-cross-origin"              always;
    add_header Permissions-Policy        "geolocation=(), microphone=()"                always;
    # connect-src must allow the API origin so the React app can call /api/*
    add_header Content-Security-Policy   "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self';" always;

    # ── General ───────────────────────────────────────────────────────────────
    access_log        /var/log/nginx/direttore.access.log combined;
    error_log         /var/log/nginx/direttore.error.log  warn;
    client_max_body_size 64m;

    # ── FastAPI backend — /api/* ──────────────────────────────────────────────
    location /api/ {
        proxy_pass         http://direttore_api;   # no trailing slash → /api/foo stays /api/foo
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";   # required for upstream keepalive
        proxy_read_timeout    120s;
        proxy_connect_timeout  10s;
        proxy_send_timeout     60s;
    }

    # ── FastAPI docs / schema ─────────────────────────────────────────────────
    location ~ ^/(docs|redoc|openapi\.json)(/.*)?$ {
        proxy_pass         http://direttore_api;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
    }

    # ── React frontend (+ Vite HMR WebSocket in dev mode) ────────────────────
    #
    # Vite's HMR WebSocket is served on the same port as the dev server,
    # distinguished only by the "Upgrade: websocket" header.  We detect it
    # with $http_upgrade and set Connection accordingly.
    location / {
        proxy_pass         http://direttore_frontend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        # WebSocket upgrade support (needed for Vite HMR; harmless in prod)
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection $connection_upgrade;
    }
}

# =============================================================================
# PLAIN HTTP — use this block instead of the two blocks above when TLS is not
# yet available (internal networks, local dev, staging behind a VPN, etc.).
# Delete the HTTP-redirect and HTTPS server blocks above if using this.
# =============================================================================
# server {
#     listen 80;
#     listen [::]:80;
#     server_name direttore.example.com;
#
#     access_log /var/log/nginx/direttore.access.log combined;
#     error_log  /var/log/nginx/direttore.error.log  warn;
#
#     client_max_body_size 64m;
#
#     location /api/ {
#         proxy_pass         http://direttore_api;
#         proxy_http_version 1.1;
#         proxy_set_header   Host              $host;
#         proxy_set_header   X-Real-IP         $remote_addr;
#         proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
#         proxy_set_header   Connection        "";
#         proxy_read_timeout 120s;
#     }
#
#     location ~ ^/(docs|redoc|openapi\.json)(/.*)?$ {
#         proxy_pass         http://direttore_api;
#         proxy_http_version 1.1;
#         proxy_set_header   Host              $host;
#         proxy_set_header   X-Real-IP         $remote_addr;
#         proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
#         proxy_set_header   Connection        "";
#     }
#
#     location / {
#         proxy_pass         http://direttore_frontend;
#         proxy_http_version 1.1;
#         proxy_set_header   Host              $host;
#         proxy_set_header   X-Real-IP         $remote_addr;
#         proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
#         proxy_set_header   Upgrade    $http_upgrade;
#         proxy_set_header   Connection $connection_upgrade;
#     }
# }

# =============================================================================
# STATIC FILE ALTERNATIVE — serve the built React bundle directly from nginx
# (remove the frontend upstream and the "/" proxy_pass location above, then
#  uncomment this block and set the correct dist path)
# =============================================================================
# location / {
#     root  /var/www/direttore/frontend/dist;
#     index index.html;
#     try_files $uri $uri/ /index.html;   # SPA client-side routing fallback
# }
