! BGP Configuration Template - {{ bgp_as }}
! Generated: {{ now().strftime('%Y-%m-%d %H:%M') }}

router bgp {{ bgp_as }}
   {% if vrf is defined and vrf != 'default' %}
   vrf {{ vrf }}
   {% endif %}

   {% if router_id is defined %}
   router-id {{ router_id }}
   {% endif %}

   {% if maximum_paths is defined %}
   maximum-paths {{ maximum_paths.ebgp|default(4) }} ebgp
   maximum-paths {{ maximum_paths.ibgp|default(8) }} ibgp
   {% endif %}

   {% if bgp_neighbors is defined %}
   {% for neighbor in bgp_neighbors %}
   neighbor {{ neighbor.ip }} remote-as {{ neighbor.as }}
   {% if neighbor.description is defined %}
   neighbor {{ neighbor.ip }} description {{ neighbor.description }}
   {% endif %}
   {% if neighbor.ebgp_multihop is defined and neighbor.ebgp_multihop > 1 %}
   neighbor {{ neighbor.ip }} ebgp-multihop {{ neighbor.ebgp_multihop }}
   {% endif %}
   {% if neighbor.update_source is defined %}
   neighbor {{ neighbor.ip }} update-source {{ neighbor.update_source }}
   {% endif %}
   {% if neighbor.password is defined %}
   neighbor {{ neighbor.ip }} password 7 {{ neighbor.password }}
   {% endif %}
   {% if neighbor.route_map_in is defined %}
   neighbor {{ neighbor.ip }} route-map {{ neighbor.route_map_in }} in
   {% endif %}
   {% if neighbor.route_map_out is defined %}
   neighbor {{ neighbor.ip }} route-map {{ neighbor.route_map_out }} out
   {% endif %}
   {% if neighbor.send_community is defined and neighbor.send_community %}
   neighbor {{ neighbor.ip }} send-community
   {% endif %}
   {% if neighbor.soft_reconfiguration is defined and neighbor.soft_reconfiguration %}
   neighbor {{ neighbor.ip }} soft-reconfiguration inbound
   {% endif %}
   {% endfor %}
   {% endif %}

   {% if address_families is defined %}
   {% for af in address_families %}
   address-family {{ af.name }}
      {% if af.maximum_prefixes is defined %}
      neighbor {{ af.neighbor }} maximum-prefixes {{ af.maximum_prefixes }} {{ af.warning_threshold|default(80) }} restart 15
      {% endif %}
      {% if af.next_hop_self is defined and af.next_hop_self %}
      neighbor {{ af.neighbor }} next-hop-self
      {% endif %}
   {% endfor %}
   {% endif %}

   {% if peer_groups is defined %}
   {% for pg in peer_groups %}
   neighbor {{ pg.name }} peer-group
   neighbor {{ pg.name }} remote-as {{ pg.as }}
   {% if pg.password is defined %}
   neighbor {{ pg.name }} password 7 {{ pg.password }}
   {% endif %}
   {% if pg.route_map_in is defined %}
   neighbor {{ pg.name }} route-map {{ pg.route_map_in }} in
   {% endif %}
   {% if pg.route_map_out is defined %}
   neighbor {{ pg.route_map_out }} out
   {% endif %}
   {% endfor %}
   {% endif %}
! End of BGP configuration
